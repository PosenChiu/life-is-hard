# ðŸ—‚ï¸ Project Blueprint & Coding Rules

> **Always follow everything in this document.**
> When I ask you to â€œadd/modify Xâ€, do **not** deviate from these rules unless I explicitly say so in that same request.

## 1 Folder Responsibilities

| Folder                  | What goes here                                                                                              | May import                   |
| ----------------------- | ----------------------------------------------------------------------------------------------------------- | ---------------------------- |
| **cmd**                 | `main.go` only â€“ start-up, DI, config, logger, Echo server, router binding.                                 | â€”                            |
| **internal/db**         | DB & cache bootstrap (`pgxpool`, Redis), helper transactions, and **migrations** driver.                    | repository, service          |
| **internal/dto**        | **Pure struct definitions** for request/response, each with `swagger:model` comment.                        | ***Only handler***           |
| **internal/handler**    | HTTP endpoints: parse input, call service / repository, return JSON. No DB code, no business logic.         | ***Only router***            |
| **internal/middleware** | Pre-handler cross-cutting concerns (JWT auth, logging, rate-limit).                                         | ***Only router***            |
| **internal/model**      | DB schema structs (`db:""`, `json:""`).                                                                     | anywhere                     |
| **internal/repository** | All SQL + cache CRUD. *This is the **only** place allowed to hit the database or Redis directly.*           | service, handler             |
| **internal/router**     | Central Echo router with groups, versioning, Swagger handler, middleware wiring.                            | â€”                            |
| **internal/service**    | Business rules, algorithms, helpers (e.g. `authentication.go`). **Never** touch DB directlyâ€”use repository. | handler, repository, service |
| **docs**                | Auto-generated by **swaggo/swag** (`swagger.json`, `docs.go`).                                              | generated (do not edit)      |

______________________________________________________________________

## 2 Coding Conventions

1. **File names**: snake_case (`reset_password_me.go`).

1. **Doc comments**:
   â€¢ Package line: `// Package users â€¦`
   â€¢ Exported items: `// Create resets â€¦`

1. **Function signatures**:

   ```go
   func (s *UserService) GetByID(ctx context.Context, id int) (*model.User, error)
   ```

   `context.Context` first, `error` last.

1. **Error wrapping** (repository layer):

   ```go
   return nil, fmt.Errorf("userrepo.GetByID: %w", err)
   ```

   Handler converts to HTTP 4xx/5xx with `dto.HTTPError`.

1. **Transactions**: start in repository, `defer tx.Rollback(ctx)`, `tx.Commit(ctx)` on success.

1. **Cache pattern**: read-through (Redis â†’ fallback DB â†’ set Redis) and write-invalidate.

1. **Logging**: use the shared logger injected in `cmd/service/main.go`; never create a new logger in handlers.

1. **Testing**:
   â€¢ Repository: pgxpool mock or Dockerised Postgres in CI.
   â€¢ Service: repository interface mocked with `testify/mock`.
   â€¢ Handler: `httptest`, mocked service.

1. **Build & tools** (see `Makefile`):
   â€¢ `make dev` â€“ run `air` hot-reload.
   â€¢ `make swag` â€“ `swag fmt && swag init --generalInfo cmd/service/main.go`.
   â€¢ `make lint` â€“ `golangci-lint run`.

1. **Handler folder â‡” API path mapping**
   The first-level sub-folder under `internal/handler` **must match** the first path segment after `/api`.
   Example:

   ```text
   internal/handler/users/create.go   â‡’  /api/users/create
   internal/handler/oauth/token.go    â‡’  /api/oauth/token
   ```

   This keeps files, routers, and URL structure in sync.

______________________________________________________________________

## 3 Swagger (swaggo/swag) Rules

### DTO example â€” `internal/dto/http_error.go`

```go
// HTTPError represents a JSON error response.
// swagger:model HTTPError
package dto

type HTTPError struct {
    // message describes the error
    Message string `json:"message"`
}
```

### Handler example â€” `internal/handler/auth/login.go`

```go
// Login authenticates a user and returns a JWT token.
// @Summary      User login
// @Description  Authenticate user credentials and return JWT token
// @Tags         auth
// @Accept       json
// @Produce      json
// @Param        body  body      dto.LoginRequest   true  "Login payload"
// @Success      200   {object}  dto.LoginResponse
// @Failure      400   {object}  dto.HTTPError  "Invalid request"
// @Failure      401   {object}  dto.HTTPError  "Unauthorized"
// @Router       /api/login [post]
func Login(c echo.Context) error {
    ...
}
```

After adding or changing handlers/DTOs, run:

```bash
make swag   # or: swag init --generalInfo cmd/service/main.go --output docs
```

______________________________________________________________________

## 4 How to Ask for New Code

Copy-paste **everything up to here**, then append your instruction:

```text
### Task
Please add a new function in `internal/repository/user.go`:

// ExistsUserByEmail returns true if the email is already taken.
func ExistsUserByEmail(ctx context.Context, pool *pgxpool.Pool, email string) (bool, error) { â€¦ }

Remember to:
* obey folder/import rules,
* wrap errors,
* add unit tests under `internal/repository/user_test.go`,
* add Swagger comments if the change touches handler or dto.
```

______________________________________________________________________

> âœ… **Key addition (#10)**: *handler folder names must mirror the first `/api` path segment.*
> `internal/handler/users/xxx.go` **always** serves `/api/users/â€¦` routes.
